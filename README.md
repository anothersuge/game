# 绿萝狼锐评

一个供朋友间使用的游戏评价网站

## 核心功能模块

### 1. 用户系统
- 用户注册 / 登录 / 注销
- 用户资料查看与编辑（昵称、头像、简介）
- 好友系统（添加好友、查看好友列表）

### 2. 游戏信息管理
- 游戏列表展示（分页、搜索、筛选）
- 游戏详情页（名称、评分、描述、评价列表）
- 游戏添加 / 编辑 / 删除（管理员权限）

### 3. 评价系统
- 用户对游戏进行评分（1-5星，每半星一个间隔）
- 撰写评价
- 点赞其他用户的评价
- 查看游戏的平均评分和评价统计

### 4. 社交互动
- 好友动态流（朋友最近评价了哪些游戏）
- 点赞通知
- 简单的排行榜（评分最高的游戏、活跃用户）

### 5. 管理后台
- 用户管理
- 游戏数据管理
- 举报处理

## 技术架构

- 后端架构：Spring Boot 3 + Java 21
- 框架：Spring Boot 3 + Spring Security + Spring Data JPA
- 数据库：SQLite
- 模板引擎：Thymeleaf（前后端不分离）
- 缓存：Caffeine（用于点赞查询优化）+ Redis（用于排行榜、热门游戏等）

## 重要技术细节

### 敏感词过滤
系统实现了敏感词过滤功能，可以对用户名、游戏名和评论内容进行过滤。
- 敏感词库文件位于 src/main/resources/sensitive-words.txt
- 过滤器实现在 com.lvluolang.game.util.SensitiveWordFilter 类中
- 当检测到敏感词时，系统会静默处理（不保存到数据库但返回成功响应）

### AI生成描述的异步处理
为了提升用户体验，游戏描述的AI生成过程是异步进行的：
1. 当创建新游戏时，系统会先设置默认描述"暂无描述"
2. 然后异步调用AI服务生成游戏描述
3. AI生成完成后，系统会自动更新游戏描述

这种设计确保了用户无需等待AI生成过程完成就能继续操作。

### 定时任务
系统包含以下定时任务：

1. 游戏描述更新任务：每小时执行一次，检查并更新描述为"暂无描述"的游戏
2. 点赞记录清理任务：每小时执行一次，清理超过一天的点赞记录，确保一个IP每天可以对一个评论点赞一次

此外，系统还使用Caffeine缓存来优化点赞查询性能，减少数据库访问次数。

### Nginx 配置
为了在生产环境中使用 80 端口访问应用，同时避免以 root 权限运行应用，可以使用 Nginx 作为反向代理。
1. 将应用运行在 8080 端口（非特权端口）
2. 配置 Nginx 监听 80 端口并将请求转发到 8080 端口
3. Nginx 配置示例可在项目根目录的 nginx.conf 文件中找到

## 配置要求

1. Java 21+
2. Maven 3.6+

## 快速开始

最近对游戏库页面的数据获取方式进行了优化：

1. 游戏库页面现在只显示最近创建的100个游戏，不再显示所有游戏
2. 为SQLite数据库配置了连接池以提高性能
3. 为Game实体添加了数据库索引以优化查询性能
4. 为游戏库查询添加了Caffeine缓存以提高性能

这些更改解决了之前可能存在的性能问题，特别是在游戏数量较多时的页面加载速度。

1. 克隆项目
2. 配置DashScope API密钥（重要！）
3. 运行项目

## DashScope API密钥配置

要使用AI生成功能，您需要配置DashScope API密钥：

1. 访问[阿里云DashScope控制台](https://dashscope.console.aliyun.com/)申请API密钥
2. 在`src/main/resources/application.yml`文件中找到以下配置：

```yaml
dashscope:
  api:
    key: your-api-key-here
```

3. 将`your-api-key-here`替换为您从阿里云获取的实际API密钥

## DashScope AI服务配置

除了API密钥，您还可以配置AI模型和提示词模板：

```yaml
dashscope:
  api:
    key: your-api-key-here
  model:
    name: qwen-plus
  prompt:
    template: 请联网搜索,为游戏{gameName}生成一段简短的游戏介绍,不超过150字.如果发现这个游戏名字是乱填的不存在,就返回无介绍,不要瞎编。但是有新闻报道的即将发售的游戏可以写上新闻、测试资讯、预计发售日期等
```

- `dashscope.model.name`：指定使用的AI模型，默认为`qwen-plus`
- `dashscope.prompt.template`：自定义提示词模板，其中`{gameName}`会被替换为实际的游戏名称

## AI生成描述的异步处理

为了提升用户体验，游戏描述的AI生成过程是异步进行的：

1. 当创建新游戏时，系统会先设置默认描述"暂无描述"
2. 然后异步调用AI服务生成游戏描述
3. AI生成完成后，系统会自动更新游戏描述

这种设计确保了用户无需等待AI生成过程完成就能继续操作。

## 定时任务

系统包含以下定时任务：

1. 游戏描述更新任务：每小时执行一次，检查并更新描述为"暂无描述"的游戏
2. 点赞记录清理任务：每小时执行一次，清理超过一天的点赞记录，确保一个IP每天可以对一个评论点赞一次

此外，系统还使用Caffeine缓存来优化点赞查询性能，减少数据库访问次数。

## 架构问题分析

### 1. 性能优化方面
- N+1 查询问题 ：在 HomeController.gameDetail 方法中，获取游戏详情时先查询游戏信息，然后在模板中可能遍历游戏的评论列表，这可能导致额外的数据库查询。建议使用JOIN FETCH优化查询。
- 排行榜查询效率 ： getTopRatedGames 和 getRecentReviews 等方法直接返回大量数据，对于未来可能的增长没有分页处理。

### 2. 数据一致性问题
- 游戏评分更新 ：在 ReviewService.saveReview 方法中，保存评论后更新游戏的平均评分，但这个操作不是原子性的。如果在计算平均分时有并发操作，可能导致数据不一致。建议使用数据库事务或在数据库层面实现。
- 点赞计数更新 ： ReviewService.likeReview 方法中更新点赞数也不是原子性的，存在并发问题。

### 3. 安全性方面
- IP地址限制 ：当前使用IP地址限制点赞功能，但没有考虑IP地址可能变化的情况，以及IPv6支持问题。对于朋友间使用的场景，可以考虑使用简单的会话标识。
- 敏感词过滤 ：虽然已实现敏感词过滤，但过滤逻辑是在控制器层实现的，建议将其移到服务层或使用AOP实现。

### 4. 代码结构问题
- 业务逻辑重叠 ：在 HomeController.submitReview 方法中同时处理了游戏创建和评论保存的逻辑，建议将游戏创建逻辑移到 GameService 中。
- 重复代码 ：在多个服务类中都有类似的获取客户端IP地址的代码，可以提取到工具类中。

### 5. 数据库设计问题
- 缺少索引 ：在 games 表的 name 、 genre 、 developer 等常用查询字段上缺少索引，可能影响查询性能。
- ReviewLike表设计 ：使用IP地址作为唯一约束可能不够稳定，建议考虑其他标识符。

## 代码优化建议

1. 使用构造函数注入替代@Autowired字段注入
2. 使用records简化数据载体类
3. 使用Stream API和Optional链式操作简化代码
4. 使用var关键字简化局部变量声明
5. 使用Pattern Matching for instanceof (Java 16)
6. 使用switch表达式简化switch语句
7. 使用Text Blocks (Java 15)
8. 使用Sealed Classes (Java 17)
9. 使用Virtual Threads (Java 21)
10. 使用Lombok的@Builder和@SuperBuilder
11. 使用Spring Boot 3的新特性
12. 使用JPA 3.1的新特性

这些改进将使代码更加现代化，利用了Java 21、Spring Boot 3、Lombok和JPA的新特性，提高了代码的可读性和维护性。

## 运行项目

```bash
mvn spring-boot:run
```

访问 http://localhost:8080 查看应用

## 测试

运行单元测试：

```bash
mvn test
```